---
title: "Presence/pseudo-absence species distribution modelling with the mopa package"
author: "Maialen Iturbide"
date: "19/11/2014"
output:
  html_document:
    fig_width: 6
---

This an example of a full species distribution modelling process carried out with the package `mopa` in R. Pseudo--absences are generated in three-steps combining profiling techniques and background extent limitations. 

##install the mopa package

The `mopa` package is available on github. 

We recomend the `devtools` package to download and install `mopa` from the repository.

```{r,eval=FALSE}
if (!require(devtools)) install.packages("devtools")
devtools::install_git("https://github.com/miturbide/mopa")
```

```{r}
library(mopa)
```

##Prepare data

Regarding presence data, it has been evidenced that conventional SDM cannot capture the climatic response of species by treating them as homogeneous units. In this connection, it has been suggested that research in environmental niche modeling should focus in broad distribution subunits of the species. Thus, functions in the `mopa` package are prepared to run with more than one group of presences at the same time (could be a list of either distribution subunits of a single species or distribution of multiple species), anyway, functions also perform with a single group or species (data frame). In this example we use a data set (list) of two phylogenetic groups (H11 and H5) of  *Quercus* sp in Europe. This is, R--object `Oak_phylo2`, available with the `mopa` package. 


```{r, echo=TRUE}
data(eu)
data(Oak_phylo2)

plot(eu, col="grey", asp=1)
for (i in 1:length(Oak_phylo2)){
  points(Oak_phylo2[[i]], pch="*", cex=0.5, 
         col = colors()[i*50])
}
```

Predictor variables are typically organized as raster (grid) type files. The set of predictor variables (rasters) can be used to make a `RasterStack`, which is a collection of `RasterLayer` objects (see `Raster-class` in the `raster` package for more info). 


```{r}
# RatserStack of envirinmental variables
data(biostack)
plot(biostack)
```


The regular point grid which covers the continental area can be created as follows.

```{r, eval=FALSE}
ac<-xyFromCell(biostack[[1]],  1:ncell(biostack[[1]]))
ex<-extract(biostack[[1]], ac)
sp_grid<-SpatialPoints(ac[-which(is.na(ex)),])
projection(sp_grid)<-CRS("+proj=longlat +init=epsg:4326")
```

Anyway, R-object `sp_grid` is available in `mopa`, covering the World at 10 km resolution.


```{r}
data(sp_grid)
```

Function `boundingCoords` creates the matrix of bounding coordinates around point records (xy records). In this case, since `Oak_phylo2` object is a list of two groups of points, a list of two matrixes will be created.

```{r}
 oak.extension<-boundingCoords(Oak_phylo2)
```

Function `delimit` creates polygon shapes from bounding coordinates and limits `SpatialPoints` data `sp_grid` to the defined boundaries, in other words, does the intersection of the background point grid with the bounding boxes. A list with two objects is obtained, (1)bbs: polygon shape of the bounding boxes and (2)bbs.grid: list of data frames of the background point grid limited by the bounding coordinates.


```{r}
box.grid<-delimit(oak.extension, sp_grid, names(Oak_phylo2))
plot(box.grid[[1]], asp=1)
for (i in 1:length(Oak_phylo2)){
  points(Oak_phylo2[[i]], col=colors()[i*50])
}
```


##Three--step pseudo--absences generation

 
###STEP1: environmental profiling

The first step is the selection of the environmental unsuitable areas with a presence only algorithm (function `OCSVMprofiling`). It runs One-class support vector machines (OCSVM) for each oak group.

```{r}
unsuitable.bg <-OCSVMprofiling(xy = Oak_phylo2, varstack = biostack, bbs.grid = box.grid$bbs.grid)
plot(unsuitable.bg$absence$H11, pch="*", asp=1)
points(unsuitable.bg$presence$H11, pch="*", col= "pink2")
```

###STEP2: background extents

The second step is the limitation of the background by the definition of a threshold distance.
To do so, here we apply a criteria based in the performance of the SDM considering different extents in each study area. Thus, before modeling, backgrounds of different extent must be created with function `bgRadio`. In the example below, extents are created for a sequence of 100 km between distances, from 20 km to the length of the half diagonal of the bounding box.

```{r}
ext <-bgRadio(xy = Oak_phylo2, bounding.coords = oak.extension, bg.absence = unsuitable.bg$absence, start = 0.166, by = 0.83, unit = "decimal degrees")
#plot presences and background extents corresponding to 520 km, 120 km and 20 km distances
plot(ext$H11$km520, col="green4", pch="*", asp=1)
points(ext$H11$km120, pch="*")
points(ext$H11$km20, pch="*", col="blue")
points(Oak_phylo2$H11, col="red", pch= ".", cex=1.5)
```

Listed matrixes with xy coordinates are obtained, each matrix correspond to a different background extent.

###STEP3: pseudo-absences sampling

In the third step, with function `PseudoAbsences`, you can create pseudo--absences either at random or with k-means clustering, by modifying argument `kmeans`. You can also set the prevalence (proportion of presences against pseudo--absences) and the exclusion buffer (minimum distance to be kept to presences without pseudo-absences).

#### At random

In the example below, pseudo--absences are generated at random, in equal number to presences and keeping a 10 km distance to presences.

```{r}
pa_random <-PseudoAbsences(xy = Oak_phylo2, bg.grids = ext, exclusion.buffer = 0.083, prevalence = 0.5, kmeans = FALSE)
#plot presences/pseudo-absences for group H11 considering the background extent of 520 km
plot(ext$H11$km520, pch="*", col= "grey", cex=.5, asp=1)
points(pa_random$H11$km520, col="red", pch=".", cex=4)
points(Oak_phylo2$H11, col="blue", pch=".", cex=3)
```

#### With k-means clustering

In the example below, pseudo-absences are generated with k-means clustering, in equal number to presences and keeping a 10 km distance to presences.


```{r, warning=FALSE}
pa_kmeans <-PseudoAbsences(xy = Oak_phylo2, bg.grids = ext, exclusion.buffer = 0.083, prevalence = 0.5, kmeans = TRUE)
#plot presences/pseudo-absences for group H11 considering the background extent of 520 km
plot(ext$H11$km520, pch="*", col= "grey", cex=.5, asp=1)
points(pa_kmeans$H11$km520, col="red", pch=".", cex=4)
points(Oak_phylo2$H11, col="blue", pch=".", cex=3)
```

###Put presences and pseudo--absences together

Function `bindPresAbs` binds presence and absence data for each background extension.

```{r}
presaus <-bindPresAbs(presences = Oak_phylo2, absences = pa_random)
```

##Species distribution modeling


The `allModeling` function does the species distribution modelling and k-fold cross validation for a set of presence/absence data per species corresponding to a different background 
extent. Algorithms supported are "glm", "svm", "maxent", "mars", "randomForest", "cart.rpart" 
and "cart.tree".

In the example below, we do a 10--fold cross validation of the "mars" modelling algorithm.

```{r}
modirs <-allModeling(data = presaus, varstack = biostack, k = 10, algorithm = "mars", destdir = getwd(), projection = CRS("+proj=longlat +init=epsg:4326"))
```

Named Rdata objects are stored in the specified path. Each Object is given a name indicating the algorithm, background extent, and species in this order (if a single species is provided no name is given for de species). Character object with listed files is returned. Each Rdata consists of a list with six components:

	(1)allmod: fitted model with all data for training, 
	(2)auc: AUC statistic in the cross validation,
	(3)kappa: kappa statistic in the cross validation,
	(4)tss: true skill statistic in the cross validation,
	(5)mod: fitted model with partitioned data, 
	(6)p: cross model prediction. 


To select the model corresponding to the geographical extent beyond which the AUC scored by the model does not increase we need to load the generated data and extract AUC values with function `loadTestValues`.

```{r}
auc_mars <-loadTestValues(data = presaus, test = "auc", algorithm = "mars")
library(lattice)
levelplot(auc_mars ,aspect=5 ,at =seq(0.5,1,0.01), col.regions=bpy.colors, xlab="Haplogroups", ylab="Background extent (km)", main = "AUC")
```

To extract the extent at which maximum AUC value is scored, we use function `indextent`.

```{r}
ind<-indextent(auc_mars)
ind
```

Thus, the **ind** object in this example gives the index of the background extent to be considered for each group/species and is going to be used to extract definitive model components and data with function loadDefinitiveModel as follows. 

```{r}
def <-loadDefinitiveModel(presaus, ind, "allmod", "mars")
```

Now we have the definitive fitted model, we can generate a suitability map this way:

```{r}
# suitability map for the oak group H11
## function "biomat" prepares matrix with variables for modelling
projectionland <-biomat(cbind(box.grid$bbs.grid$H11, rep(1,nrow(box.grid$bbs.grid$H11))), biostack)

p <-predict(def$H11, projectionland[,-1])
  p[which(p < 0)]<- 0
  p[which(p > 1)]<- 1
spp<-SpatialPixelsDataFrame(box.grid$bbs.grid$H11, as.data.frame(p))
ras<-raster(spp)
plot(ras)
```



